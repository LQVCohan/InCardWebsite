<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Card Printer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">üÉè</div>
        <div>
          <h1>Card Printer Pro</h1>
          <p>In card TCG / Yu-Gi-Oh / Digimon ‚Äì ch·∫°y offline.</p>
        </div>
      </div>
      <div class="deck-status">
        <span id="currentDeckName" class="deck-name">üóÇ Deck: <em>Ch∆∞a ch·ªçn</em></span>
        <button id="updateDeckBtn" class="btn outline small" disabled title="Ghi ƒë√® deck ƒëang m·ªü">üíæ C·∫≠p nh·∫≠t Deck</button>
      </div>
    </header>

    <main class="container">
      <!-- Uploader m·∫∑t tr∆∞·ªõc -->
      <section class="uploader" id="dropzone" aria-label="K√©o & th·∫£ ·∫£nh">
        <p class="drop-title"><strong>K√©o & th·∫£ ·∫£nh card ho·∫∑c file .ydk v√†o ƒë√¢y</strong></p>
        <p class="drop-sub">ho·∫∑c</p>
        <label class="btn" for="fileInput">
          Ch·ªçn ·∫£nh
          <input type="file" id="fileInput" accept="image/*,.ydk" multiple hidden />
        </label>
        <p class="hint">C√≥ th·ªÉ d√°n (Ctrl + V) ·∫£nh ho·∫∑c URL ·∫£nh tr·ª±c ti·∫øp. File .ydk s·∫Ω t·ª± l·∫•y ·∫£nh theo ID.</p>
        <p class="drop-hint" id="dropHint">Th·∫£ v√†o ƒë√¢y üëá</p>
      </section>

      <!-- Uploader m·∫∑t sau (·∫©n/hi·ªán theo ch·∫ø ƒë·ªô) -->
      <section class="uploader small-uploader" id="backSection" style="display:none">
        <p><strong>·∫¢nh m·∫∑t sau</strong></p>
        <label class="btn" for="backInput">
          Ch·ªçn ·∫£nh m·∫∑t sau
          <input type="file" id="backInput" accept="image/*" hidden />
        </label>
        <p id="backInfo" class="hint">Ch∆∞a ch·ªçn m·∫∑t sau.</p>
      </section>

      <!-- Controls -->
      <section class="controls" aria-label="Thi·∫øt l·∫≠p in">
        <div>
          <label for="cardPreset">K√≠ch th∆∞·ªõc card</label>
          <select id="cardPreset">
            <option value="63x88">TCG 63√ó88 mm</option>
            <option value="59x86">Yu-Gi-Oh 59√ó86 mm</option>
            <option value="70x120">70√ó120 mm</option>
            <option value="custom">T√πy ch·ªânh</option>
          </select>
        </div>

        <div id="customSize" class="custom-size hidden">
          <label>R·ªông √ó Cao (mm)</label>
          <div class="inline-inputs">
            <input type="number" id="cardW" value="63" min="20" />
            <span>x</span>
            <input type="number" id="cardH" value="88" min="20" />
          </div>
        </div>

        <div>
          <label for="pageSize">Kh·ªï gi·∫•y</label>
          <select id="pageSize">
            <option value="a4">A4 (210√ó297)</option>
            <option value="letter">Letter (216√ó279)</option>
          </select>
        </div>

        <div>
          <label for="orientation">H∆∞·ªõng gi·∫•y</label>
          <select id="orientation">
            <option value="portrait">D·ªçc</option>
            <option value="landscape">Ngang</option>
          </select>
        </div>

        <div>
          <label for="margin">L·ªÅ trang (mm)</label>
          <input type="number" id="margin" value="4" min="0" />
        </div>

        <div>
          <label for="gap">Kho·∫£ng c√°ch gi·ªØa card (mm)</label>
          <input type="number" id="gap" value="2" min="0" />
        </div>

        <div>
          <label for="bleed">Bleed (mm)</label>
          <input type="number" id="bleed" value="0" min="0" />
        </div>

        <div>
          <label for="fileName">T√™n file</label>
          <input type="text" id="fileName" value="cards" />
        </div>

        <div>
          <label for="frontBackMode">Ch·∫ø ƒë·ªô in</label>
          <select id="frontBackMode" title="Ch·ªâ m·∫∑t tr∆∞·ªõc / sau ho·∫∑c c·∫£ hai">
            <option value="front-only" selected>Ch·ªâ m·∫∑t tr∆∞·ªõc</option>
            <option value="back-only">Ch·ªâ m·∫∑t sau</option>
            <option value="front-back">M·∫∑t tr∆∞·ªõc + m·∫∑t sau</option>
          </select>
        </div>

        <div>
          <label for="backFlipMode">CƒÉn m·∫∑t sau</label>
          <select id="backFlipMode" disabled title="D√πng khi in 2 m·∫∑t">
            <option value="none" selected>Kh√¥ng ƒë·∫£o</option>
            <option value="short">In 2 m·∫∑t m√©p ng·∫Øn</option>
            <option value="long">In 2 m·∫∑t m√©p d√†i</option>
          </select>
        </div>

        <div>
          <label for="cropMarks">D·∫•u c·∫Øt</label>
          <select id="cropMarks">
            <option value="none">Kh√¥ng</option>
            <option value="short" selected>Ng·∫Øn</option>
            <option value="full">ƒê·∫ßy ƒë·ªß</option>
          </select>
        </div>

        <div>
          <label for="autoFit">Nh·ªìi 9 card?</label>
          <select id="autoFit">
            <option value="on" selected>T·ª± co ƒë·ªÉ ƒë·ªß 9</option>
            <option value="off">Gi·ªØ ƒë√∫ng size</option>
          </select>
        </div>

        <div class="actions">
          <button id="exportPdf" class="btn primary" title="Xu·∫•t PDF 9 card/trang">Xu·∫•t PDF</button>
          <button id="testWord" class="btn outline" title="T·∫°o file test DOCX">Test Word</button>
          <button id="exportDocx" class="btn secondary" title="Xu·∫•t DOCX (Word)">Xu·∫•t DOCX</button>
          <button id="undoBtn" class="btn outline" title="Ho√†n t√°c 1 b∆∞·ªõc">‚Ü∂ Ho√†n t√°c</button>
          <button id="saveDeck" class="btn muted">L∆∞u deck</button>
          <button id="manageDeck" class="btn outline">üìÅ Qu·∫£n l√Ω deck</button>
          <button id="exportJson" class="btn outline">Xu·∫•t JSON</button>
          <button id="exportYdk" class="btn outline">Xu·∫•t YDK</button>
          <button id="importBtn" class="btn outline">Nh·∫≠p JSON</button>
          <input type="file" id="importJson" accept="application/json" hidden />
          <button id="clearDeck" class="btn danger">Xo√° h·∫øt</button>
        </div>
      </section>

      <!-- Danh s√°ch -->
      <section>
        <h2 style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
          Danh s√°ch card
          <span class="pill">·∫¢nh duy nh·∫•t: <strong id="countUnique">0</strong></span>
          <span class="pill">B·∫£n in: <strong id="countTotal">0</strong></span>
        </h2>
        <p class="small">K√©o ƒë·ªÉ ƒë·ªïi th·ª© t·ª±. D√πng + / - ƒë·ªÉ tƒÉng gi·∫£m s·ªë l∆∞·ª£ng in. B·∫•m v√†o ‚ÄúQu·∫£n l√Ω deck‚Äù ƒë·ªÉ l∆∞u/t·∫£i/qu·∫£n l√Ω.</p>
        <ul id="previewList" class="preview-list"></ul>
      </section>

      <!-- Preview b·ªë c·ª•c -->
      <section class="preview-panel">
        <h3>Preview b·ªë c·ª•c</h3>
        <canvas id="layoutPreview" width="210" height="297" aria-label="S∆° ƒë·ªì trang in"></canvas>
        <p class="hint">In ·ªü 100% / Actual size ƒë·ªÉ ƒë√∫ng mm. PDF/DOCX m·ªõi l√† chu·∫©n ƒë·ªÉ in.</p>
      </section>
    </main>

    <footer class="footer">
      <p>Tip: D√°n (Ctrl + V) ·∫£nh ho·∫∑c URL. Khi in 2 m·∫∑t, ch·ªâ k√©o/ƒë·∫∑t ·∫£nh m·∫∑t sau trong √¥ ‚Äú·∫¢nh m·∫∑t sau‚Äù.</p>
    </footer>

    <!-- Modal Qu·∫£n l√Ω Deck -->
    <div id="deckManager" class="deck-modal hidden" role="dialog" aria-modal="true" aria-labelledby="deckModalTitle">
      <div class="deck-modal-content">
        <h3 id="deckModalTitle">üìö Qu·∫£n l√Ω Deck</h3>
        <div id="deckList" class="deck-list" aria-live="polite"></div>

        <div class="deck-add">
          <input type="text" id="newDeckName" placeholder="T√™n deck m·ªõi..." />
          <button id="createDeckBtn" class="btn primary">T·∫°o m·ªõi</button>
        </div>

        <div class="modal-footer">
          <button id="closeDeckManager" class="btn muted">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- Image viewer -->
    <div id="imageViewer" class="image-viewer hidden" role="dialog" aria-modal="true" aria-label="Xem ·∫£nh">
      <div class="image-viewer-content">
        <button id="closeImageViewer" class="btn outline small" aria-label="ƒê√≥ng">‚úï</button>
        <img id="imageViewerImg" alt="Card preview" />
      </div>
    </div>

    <!-- Overlay k√©o th·∫£ to√†n trang -->
    <div id="pageDropOverlay" class="page-drop-overlay" aria-hidden="true">
      <div class="page-drop-box">
        <div class="page-drop-icon">‚¨á</div>
        <div class="page-drop-text">Th·∫£ ·∫£nh, file .ydk, ho·∫∑c link ·∫£nh v√†o ƒë√¢y</div>
        <div class="page-drop-sub">(.jpg .png .webp .gif .avif‚Ä¶ URL ·∫£nh tr·ª±c ti·∫øp ho·∫∑c deck .ydk)</div>
      </div>
    </div>

    <!-- Loader th∆∞ vi·ªán auto online/offline -->
    <script>
      (async () => {
        const loadScript = (src) => new Promise((res, rej) => {
          const s = document.createElement("script");
          s.src = src; s.onload = () => res(src); s.onerror = () => rej(src);
          document.head.appendChild(s);
        });
        const DOCX_CDN = [
          "https://cdn.jsdelivr.net/npm/docx@9.5.1/dist/index.iife.js",
          "https://cdn.jsdelivr.net/npm/docx@9.4.1/dist/index.iife.js",
          "https://cdn.jsdelivr.net/npm/docx@8.5.0/dist/index.iife.js"
        ];
        const JSPDF_CDN = [
          "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
          "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
        ];
        const DOCX_LOCAL = "libs/docx.iife.js";
        const JSPDF_LOCAL = "libs/jspdf.umd.min.js";

        const tryMany = async (list, fallback) => {
          for (const url of list) {
            try { await loadScript(url); return; } catch {}
          }
          await loadScript(fallback);
        };

        if (!navigator.onLine) {
          await loadScript(DOCX_LOCAL);
          await loadScript(JSPDF_LOCAL);
        } else {
          await tryMany(DOCX_CDN, DOCX_LOCAL);
          await tryMany(JSPDF_CDN, JSPDF_LOCAL);
        }
      })();
    </script>

    <!-- Script ch√≠nh -->
    <script src="app.js"></script>
  </body>
</html>
